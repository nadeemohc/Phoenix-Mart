{% load static %}
<head>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />
</head>

<nav class="navbar navbar-dark bg-dark">
  <div class="container">
  <a class="navbar-brand fw-bold d-flex align-items-center" href="{% url 'store:index' %}">
    <img src="{% static 'img/logo.png' %}" alt="Logo" width="28" height="28" class="me-2" />
    Phoenix Cart
  </a>
    <div class="collapse navbar-collapse" id="navbarNav"></div>

    <ul class="navbar-nav align-items-center flex-row">
      {% if request.user.is_authenticated %}
      <li class="nav-item me-2 d-none d-lg-inline">
        <a href="{% url 'store:logout' %}" class="btn btn-outline-light btn-sm">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      </li>
      {% else %}
      <li class="nav-item me-2 d-none d-lg-inline">
        <a
          href="{% url 'social:begin' 'google-oauth2' %}"
          class="btn btn-outline-light btn-sm"
        >
          <i class="bi bi-box-arrow-right"></i> Login
        </a>
      </li>
      {% endif %} {% if request.user.is_authenticated %}
      <li class="nav-item me-4 d-lg-none">
        <a href="{% url 'store:logout' %}" class="btn btn-outline-light btn-sm">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      </li>
      {% else %}
      <li class="nav-item me-4 d-lg-none">
        <a
          href="{% url 'social:begin' 'google-oauth2' %}"
          class="btn btn-outline-light btn-sm"
        >
          <i class="bi bi-box-arrow-right"></i> Login
        </a>
      </li>
      {% endif %}

      <li class="nav-item d-none d-lg-inline">
        <a
          class="nav-link cart-icon position-relative"
          href="javascript:void(0)"
        >
          <i class="bi bi-cart3 fs-4"></i>
          <span
            id="cart-count"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          >
            {{ request.cart_count|default:0 }}
          </span>
        </a>
      </li>

      <li class="nav-item d-lg-none">
        <a
          class="nav-link cart-icon position-relative"
          href="javascript:void(0)"
        >
          <i class="bi bi-cart3 fs-5"></i>
          <span
            id="cart-count"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          >
            {{ request.cart_count|default:0 }}
          </span>
        </a>
      </li>

      <!-- Profile Icon (Visible only if authenticated) -->
      {% if request.user.is_authenticated and not request.user.is_guest %}
      <li class="nav-item ms-2 d-none d-lg-inline">
        <a
          class="nav-link"
          href="javascript:void(0)"
          data-bs-toggle="modal"
          data-bs-target="#profileModal"
        >
          <i class="bi bi-person-circle fs-4"></i>
        </a>
      </li>
      <li class="nav-item ms-2 d-lg-none">
        <a
          class="nav-link"
          href="javascript:void(0)"
          data-bs-toggle="modal"
          data-bs-target="#profileModal"
        >
          <i class="bi bi-person-circle fs-5"></i>
        </a>
      </li>
      {% endif %}
    </ul>
  </div>
</nav>

<div id="cartSidebar" class="cart-sidebar">
  <div class="cart-header">
    <h5>Your Cart</h5>
    <!-- <span class="close-btn" id="closeCart">&times;</span> -->
    <button id="closeCart" class="close-btn" aria-label="Close cart">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </button>
  </div>
  <div class="cart-items">
    {% if request.cart_items %} {% for item in request.cart_items %}
    <div
      class="cart-item d-flex align-items-center justify-content-between"
      data-item-id="{{ item.id }}"
    >
      <img
        src="{{ item.product.image.url }}"
        alt="{{ item.product.name }}"
        style="width: 50px; height: auto"
      />
      <div class="flex-grow-1 px-2">
        <p class="cart-item-name mb-0">{{ item.product.name }}</p>
        <p class="cart-item-price text-muted mb-0">£{{ item.product.price }}</p>
      </div>
      <input
        type="number"
        min="1"
        value="{{ item.quantity }}"
        class="form-control form-control-sm quantity-input me-2"
        style="width: 60px; flex: 0 0 auto"
      />
      <i
        class="bi bi-trash text-danger remove-item"
        style="cursor: pointer; font-size: 1.2rem"
      ></i>
    </div>
    {% endfor %} {% else %}
    <p class="text-center py-3">Your cart is empty</p>
    {% endif %}
  </div>
  <div class="cart-footer">
    <p>Total: £{{ request.cart_total|default:"0.00" }}</p>
    <button
      class="btn btn-warning w-100"
      data-bs-toggle="modal"
      data-bs-target="#checkoutModal"
    >
      Checkout
    </button>
  </div>
</div>

<div id="cartBackdrop" class="cart-backdrop"></div>

<style>
    /* Cart Icon Styles */
  .nav-link.cart-icon {
    position: relative;
    display: flex;
    align-items: center;
    color: #f8f9fa !important;
    transition: color 0.3s ease;
  }
  .nav-link.cart-icon:hover {
    color: #adb5bd !important;
  }
  #cart-count {
    font-size: 0.6rem;
    padding: 0.25em 0.4em;
  }

  /* Cart Sidebar */
  .close-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #555; /* subtle grey */
      padding: 4px;
      border-radius: 50%;
      transition: background 0.2s ease, color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .close-btn:hover {
      background: #f0f0f0;
      color: #e60023; /* red accent */
  }

  .cart-sidebar {
    position: fixed;
    top: 0;
    right: -350px;
    width: 350px;
    height: 100%;
    background: #fff;
    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
    transition: right 0.3s ease;
    z-index: 1050;
    display: flex;
    flex-direction: column;
  }
  .cart-sidebar.open {
    right: 0;
  }
  .cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
  }
  .cart-items {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
  }
  .cart-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  .cart-item img {
    margin-right: 10px;
    width: 50px;
    height: 50px;
    object-fit: cover;
  }
  .cart-item-name {
    font-weight: bold;
    font-size: 0.9rem;
    margin: 0;
  }
  .cart-item-price {
    font-size: 0.8rem;
    color: #555;
    margin: 0;
  }
  .cart-footer {
    padding: 15px;
    border-top: 1px solid #ddd;
    background: #f8f9fa;
  }

  /* Backdrop */
  .cart-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    display: none;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const cartSidebar   = document.getElementById("cartSidebar");
  const cartBackdrop  = document.getElementById("cartBackdrop");
  const closeCartBtn  = document.getElementById("closeCart");
  const cartItemsWrap = document.querySelector(".cart-items");

  // ---- Sidebar Toggle ----
  document.querySelectorAll(".cart-icon").forEach(icon => {
    icon.addEventListener("click", () => {
      cartSidebar.classList.add("open");
      cartBackdrop.style.display = "block";
    });
  });

  closeCartBtn.addEventListener("click", () => {
    cartSidebar.classList.remove("open");
    cartBackdrop.style.display = "none";
  });

  cartBackdrop.addEventListener("click", () => {
    cartSidebar.classList.remove("open");
    cartBackdrop.style.display = "none";
  });

  // ---- Refresh Cart UI ----
  function refreshCart(data) {
    if (data.success) {
      document.getElementById("cart-count").textContent = data.cart_count;
      const footerTotal = document.querySelector(".cart-footer p");
      if (footerTotal) {
        footerTotal.textContent = `Total: £${data.cart_total}`;
      }
      cartItemsWrap.innerHTML = data.cart_html;
    }
  }

  // ---- Quantity Change ----
  cartItemsWrap.addEventListener("change", function (e) {
    if (e.target.classList.contains("quantity-input")) {
      const cartItemDiv = e.target.closest(".cart-item");
      const itemId      = cartItemDiv.dataset.itemId;
      const newQuantity = e.target.value;

      fetch(`/cart/update/${itemId}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ quantity: newQuantity }),
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            refreshCart(data);
          } else {
            alert(data.error || "Failed to update cart.");
          }
        })
        .catch(err => console.error("Error updating cart:", err));
    }
  });

  // ---- Remove Item ----
  cartItemsWrap.addEventListener("click", function (e) {
    const removeBtn = e.target.closest(".remove-item");
    if (removeBtn) {
      const itemId = removeBtn.closest(".cart-item").dataset.itemId;
      removeCartItem(itemId);
    }
  });


  function removeCartItem(itemId) {
    fetch(`/cart/remove/${itemId}/`, {
      method: "POST",
      headers: { "X-CSRFToken": getCookie("csrftoken") },
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          refreshCart(data);
        } else {
          alert("Failed to remove item.");
        }
      })
      .catch(err => console.error("Error removing item:", err));
  }

  // ---- CSRF Token Helper ----
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
