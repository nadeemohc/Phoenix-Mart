{% extends 'store/base.html' %} 
{% load static %}
{% block content %}
{% include "modal/checkout.html" %}
{% include 'modal/user_profile.html' %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  /* Base styles for the product cards */
  .card-img-top {
    width: 100%;
    padding-bottom: 56.25%;
    position: relative;
    overflow: hidden;
  }

  .card-img-top img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* Media query to make the SweetAlert modal smaller on mobile */
  @media (max-width: 768px) {
    .swal2-popup {
      font-size: 0.8em !important;
      width: 85% !important;
    }

    .swal2-title {
      font-size: 1.5em !important;
    }

    .swal2-actions {
      font-size: 0.8em !important;
    }
  }

  .swal2-toast .swal2-close {
    position: absolute !important;
    top: 5px !important;
    right: 5px !important;
    transform: none !important;
  }

</style>

<div
  class="modal fade"
  id="loginModal"
  tabindex="-1"
  aria-labelledby="loginModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Login to Continue</h5>
      </div>
      <div class="modal-body">
        <a
          href="{% url 'social:begin' 'google-oauth2' %}?next=/"
          class="btn btn-primary w-100"
        >
          <i class="bi bi-google"></i> Continue with Google
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container my-5">
  <h1 class="text-center fw-bold mb-4">Born Fresh Everyday</h1>
  <div class="row g-4 justify-content-center">
    {% for product in products %}
    <div class="col-6 col-sm-6 col-md-4 col-lg-3 d-flex">
      <div class="card product-card shadow-sm flex-fill text-center">
        <div class="card-img-top">
          <img src="{{ product.image.url }}" alt="{{ product.name }}" />
        </div>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ product.name }}</h5>
          <p class="card-text text-muted">
            {{ product.description|truncatewords:12 }}
          </p>

          <form 
            method="POST" 
            action="{% url 'cart:add_to_cart' product.id %}" 
            class="d-flex flex-column mt-auto"
          >
            {% csrf_token %}
            <div
              class="d-flex justify-content-center align-items-center mb-2"
            >
              <h6 class="fw-bold mb-0 me-2">£{{ product.price }}</h6>
              <input
                type="number"
                name="quantity"
                min="1"
                value="1"
                class="form-control"
                style="max-width: 80px"
              />
            </div>

            <button 
                type="submit" 
                class="btn btn-dark w-100 add-to-cart-btn" 
                data-product-id="{{ product.id }}"
            >
                Add to Cart
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
      const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      let currentForm = null;

      addToCartButtons.forEach(button => {
          button.addEventListener('click', function(e) {
              e.preventDefault();
              currentForm = this.closest('form');

              // Check if user is authenticated
              const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};

              if (isAuthenticated) {
                  submitAddToCartForm(currentForm);
              } else {
                  loginModal.show();
              }
          });
      });

      // Handle login form submission
      document.getElementById('loginForm').addEventListener('submit', function(e) {
          e.preventDefault();

          fetch(this.action, {
              method: 'POST',
              body: new FormData(this),
              headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  loginModal.hide();
                  submitAddToCartForm(currentForm);
              } else {
                  Swal.fire({
                      icon: 'error',
                      title: 'Login Failed',
                      text: data.message || 'Please try again.',
                      toast: true,
                      position: 'top-end',
                      showConfirmButton: false,
                      timer: 3000
                  });
              }
          })
          .catch(error => {
              console.error('Error:', error);
              Swal.fire({
                  icon: 'error',
                  title: 'An error occurred',
                  text: 'Please try again.',
                  toast: true,
                  position: 'top-end',
                  showConfirmButton: false,
                  timer: 3000
              });
          });
      });

      function submitAddToCartForm(form) {
          fetch(form.action, {
              method: 'POST',
              body: new FormData(form),
              headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Update cart count in the navbar
                  document.querySelectorAll('#cart-count, .cart-count').forEach(el => {
                      el.textContent = data.cart_count;
                  });

                  // Update the cart total
                  document.querySelector('.cart-footer p').textContent = `Total: £${data.cart_total}`;

                  // Update the cart items content with the new HTML from the server
                  document.querySelector('.cart-items').innerHTML = data.cart_html;

                  // Show success message using SweetAlert
                  Swal.fire({
                      icon: 'success',
                      title: 'Added to cart!',
                      text: 'Your product has been added successfully.',
                      toast: true,
                      position: 'top-end',
                      showConfirmButton: false,
                      showCloseButton: true,
                      timer: 3000
                  });

              } else {
                  // Show error message using SweetAlert
                  Swal.fire({
                      icon: 'error',
                      title: 'Failed to add',
                      text: 'Please try again.',
                      toast: true,
                      position: 'top-end',
                      showConfirmButton: true,
                      showCloseButton: true,
                      timer: 3000
                  });
              }
          })
          .catch(error => {
              console.error('Error:', error);
              Swal.fire({
                  icon: 'error',
                  title: 'An error occurred',
                  text: 'Please try again.',
                  toast: true,
                  position: 'top-end',
                  showConfirmButton: false,
                  showCloseButton: true,
                  timer: 3000
              });
          });
      }
  });

  function googleLoginPopup() {
      const width = 500, height = 600;
      const left = (screen.width / 2) - (width / 2);
      const top = (screen.height / 2) - (height / 2);

      window.open(
          "{% url 'social:begin' 'google-oauth2' %}",
          "GoogleLogin",
          `width=${width},height=${height},top=${top},left=${left}`
      );
  }
</script>
{% endblock %}
