{% extends 'store/base.html' %} 
{% load static %}
{% block content %}
{% include "modal/checkout.html" %}
{% include 'modal/user_profile.html' %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .col-6.col-sm-6.col-md-4.col-lg-3 .product-actions {
      /* This ensures the row takes the full width of the card body */
      max-width: 100%; 
  }

  @media (max-width: 575.98px) {
      /* Mobile-specific styles for better touch interaction */
      .col-6.col-sm-6.col-md-4.col-lg-3 .product-actions .col-12 {
          /* Optional: Add a small top margin to the second button if needed, 
             but Bootstrap's g-2 row gutter should handle spacing */
      }
      
      /* Enhance the visibility of the buttons for mobile */
      .add-to-cart-btn {
          font-size: 0.9rem;
          padding: 0.6rem 0.5rem;
          min-height: 44px; /* Better touch target */
      }
      .buy-now-btn {
          font-size: 0.9rem;
          padding: 0.6rem 0.5rem;
          min-height: 44px; /* Better touch target */
      }
      
      /* Improve form controls for mobile */
      .form-control-sm, .form-select-sm {
          font-size: 0.9rem;
          padding: 0.5rem 0.4rem;
          min-height: 44px; /* Better touch target */
      }
      
      /* Better spacing for mobile cards */
      .card-body {
          padding: 1rem 0.75rem;
      }
      
      /* Improve card title readability on mobile */
      .card-title {
          font-size: 1rem;
          line-height: 1.3;
      }
      
      /* Better description text on mobile */
      .card-text {
          font-size: 0.85rem;
          line-height: 1.4;
      }
  }

  /* Ensure the buttons are side-by-side on larger screens where space permits */
  @media (min-width: 576px) {
      /* On screens >= sm, the .col-sm-6 classes will place them side-by-side */
      .product-actions .col-sm-6:first-child {
          padding-right: 0.25rem !important; /* Adjust spacing between buttons */
      }
      .product-actions .col-sm-6:last-child {
          padding-left: 0.25rem !important; /* Adjust spacing between buttons */
      }
  }
  
  /* Your existing CSS styles */
  .card-img-top {
    width: 100%;
    padding-bottom: 56.25%;
    position: relative;
    overflow: hidden;
  }
  .card-img-top img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  @media (max-width: 768px) {
    .swal2-popup {
      font-size: 0.8em !important;
      width: 85% !important;
    }
    .swal2-title {
      font-size: 1.5em !important;
    }
    .swal2-actions {
      font-size: 0.8em !important;
    }
  }
  .swal2-toast .swal2-close {
    position: absolute !important;
    top: 5px !important;
    right: 5px !important;
    transform: none !important;
  }
  
  /* Individual card state management */
  .product-card {
    transition: height 0.3s ease;
  }
  
  .product-card.description-expanded {
    /* Optional: Add any visual indication that this card is expanded */
  }
  
  /* Individual card state management - using unique IDs now */
  .description-short, .description-full {
    /* Let JavaScript handle the display logic with unique IDs */
  }
</style>

<div
  class="modal fade"
  id="loginModal"
  tabindex="-1"
  aria-labelledby="loginModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Login to Continue</h5>
      </div>
      <div class="modal-body">
        <a
          href="{% url 'social:begin' 'google-oauth2' %}?next=/"
          class="btn btn-primary w-100"
        >
          <i class="bi bi-google"></i> Continue with Google
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container my-5">
  <h1 class="text-center fw-bold mb-4">Born Fresh Everyday</h1>
  
  {% for category in categories %}
    {% if category.products.all %}
    <div class="mb-5">
      <h2 class="fw-bold mb-3 text-start border-bottom pb-2">
        {{ category.name }}
      </h2>
    
    <div class="row g-4 justify-content-start">
      {% for product in category.products.all %} 
      
      <div class="col-6 col-sm-6 col-md-4 col-lg-3 d-flex">
        <div class="card product-card shadow-sm flex-fill text-center" data-product-id="{{ product.id }}">
          <div class="card-img-top">
            <img id="product-image-{{ product.id }}" src="{% if product.variants.first.image %}{{ product.variants.first.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}" alt="{{ product.name }}" />
          </div>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title" id="product-name-{{ product.id }}">{{ product.variants.first.name|default:product.name }}</h5>
            <div class="card-text text-muted" id="product-description-{{ product.id }}">
              <span id="description-short-{{ product.id }}" class="description-short">{{ product.variants.first.description|truncatewords:12|default:"No description available" }}</span>
              <span id="description-full-{{ product.id }}" class="description-full" style="display: none;">{{ product.variants.first.description|default:"No description available" }}</span>
              {% if product.variants.first.description and product.variants.first.description|wordcount > 12 %}
                <button type="button" class="btn btn-link p-0 text-decoration-none see-more-btn" data-product-id="{{ product.id }}" style="font-size: 0.8rem;">
                  See more
                </button>
              {% endif %}
            </div>

            <form 
              method="POST" 
              action="{% url 'cart:add_to_cart' product.id %}" 
              class="d-flex flex-column mt-auto"
            >
              {% csrf_token %}
                <h5 class="fw-bold mb-2 me-2" id="price-display-{{ product.id }}">£{{ product.variants.first.price|default:"0.00" }}</h5>

              <div class="row g-2 mb-2">
                <div class="col-5 col-sm-4">
                  <input
                    type="number"
                    name="quantity"
                    min="1"
                    value="1"
                    class="form-control form-control-sm text-center" 
                  />
                </div>
                <div class="col-7 col-sm-8">
                  <select 
                      name="variant_id" 
                      class="form-select form-select-sm variant-select"  
                      required
                      data-product-id="{{ product.id }}"
                  >
                      {% for variant in product.variants.all %}
                          {% if variant.is_active %}
                          <option value="{{ variant.id }}" 
                                  data-price="{{ variant.price }}"
                                  data-name="{{ variant.name }}"
                                  data-description-short="{{ variant.description|truncatewords:12 }}"
                                  data-description-full="{{ variant.description }}"
                                  data-image="{% if variant.image %}{{ variant.image.url }}{% else %}{% static 'img/placeholder.png' %}{% endif %}">
                              {{ variant.subcategory.name }}
                          </option>
                          {% endif %}
                      {% empty %}
                          <option disabled>No variants</option>
                      {% endfor %}
                  </select>
                </div>
              </div>

              <div class="row g-2 product-actions w-100 mx-auto">
                  <div class="col-12 col-sm-6">
                      <button 
                          type="submit" 
                          class="btn btn-dark w-100 add-to-cart-btn" 
                          data-product-id="{{ product.id }}"
                      >
                          Add to Cart
                      </button>
                  </div>
                  <div class="col-12 col-sm-6">
                      <button 
                        type="button" 
                        class="btn btn-warning w-100 buy-now-btn" 
                        data-product-id="{{ product.id }}"
                      >
                        Buy Now
                      </button>
                  </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      {% endfor %}
    </div>
    </div>
    {% endif %}
  {% empty %}
  <p class="text-center">No categories with products found.</p>
  {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Constants for all elements
        const buyNowButtons = document.querySelectorAll('.buy-now-btn');
        const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
        const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
        const checkoutForm = document.getElementById('checkoutForm');
        const checkoutSummary = document.getElementById('checkoutSummary');
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        
        // Cart Sidebar elements
        const cartSidebar = document.getElementById("cartSidebar");
        const cartBackdrop = document.getElementById("cartBackdrop");
        const closeCartBtn = document.getElementById("closeCart");
        const cartItemsWrap = document.querySelector(".cart-items");
        const cartIcons = document.querySelectorAll(".cart-icon");
        const sidebarCheckoutBtn = document.getElementById("sidebarCheckoutBtn");

        // NEW: Get references to the hidden fields in the checkout modal (from checkout.html)
        const checkoutVariantIdInput = document.getElementById('checkout_variant_id');
        const checkoutQuantityInput = document.getElementById('checkout_quantity');


        // CSRF helper function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ---- Refresh Cart UI ----
        function refreshCart(data) {
          if (data.success) {
            document.getElementById("cart-count").textContent = data.cart_count;
            const footerTotal = document.querySelector(".cart-footer p");
            if (footerTotal) {
              footerTotal.textContent = `Total: £${data.cart_total}`;
            }
            // Temporarily disable listeners to avoid duplicates
            // We use a different approach now, attaching them after the change
            cartItemsWrap.innerHTML = data.cart_html;
            attachSidebarListeners(); // Re-attach listeners after content update
          }
        }
        
        // ---- Handle Quantity Updates in Checkout Modal ----
        function attachQuantityListeners() {
            const qtyInputs = checkoutSummary.querySelectorAll('.checkout-quantity-input');
            qtyInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const itemId = this.dataset.itemId;
                    const newQty = parseInt(this.value);
                    const isBuyNow = this.classList.contains('buy-now-input');

                    if (isBuyNow) {
                        // FIX: Update the hidden quantity field for final submission
                        if (checkoutQuantityInput) {
                            checkoutQuantityInput.value = newQty;
                        }
                        
                        const lineTotalCell = this.closest('tr').querySelector('.item-line-total');
                        const unitPriceCell = this.closest('tr').querySelector('td:nth-child(3)');
                        const unitPrice = parseFloat(unitPriceCell.textContent.replace('£', ''));
                        const newTotal = (unitPrice * newQty).toFixed(2);
                        lineTotalCell.textContent = '£' + newTotal;
                        
                        document.getElementById('checkoutTotal').textContent = '£' + newTotal;
                    } else {
                        fetch(`/cart/update/${itemId}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({ quantity: newQty })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                fetch(`/cart/summary/`)
                                    .then(res => res.json())
                                    .then(summary => {
                                        if (summary.success) {
                                            checkoutSummary.innerHTML = summary.summary_html;
                                            attachQuantityListeners();
                                        }
                                    });
                            }
                        });
                    }
                });
            });
        }

        // ---- Variant Selection Handler ----
        const variantSelects = document.querySelectorAll('.variant-select');
        variantSelects.forEach(select => {
            select.addEventListener('change', function() {
                const productId = this.dataset.productId;
                const selectedOption = this.options[this.selectedIndex];
                const price = selectedOption.dataset.price;
                const variantName = selectedOption.dataset.name;
                const variantDescriptionShort = selectedOption.dataset.descriptionShort;
                const variantDescriptionFull = selectedOption.dataset.descriptionFull;
                const variantImage = selectedOption.dataset.image;
                
                // Update price
                const priceDisplay = document.getElementById(`price-display-${productId}`);
                if (priceDisplay) {
                    priceDisplay.textContent = `£${price}`;
                }
                
                // Update product name
                const productNameDisplay = document.getElementById(`product-name-${productId}`);
                if (productNameDisplay && variantName) {
                    productNameDisplay.textContent = variantName;
                }
                
                // Update description
                const productDescriptionDisplay = document.getElementById(`product-description-${productId}`);
                if (productDescriptionDisplay) {
                    const shortSpan = productDescriptionDisplay.querySelector('.description-short');
                    const fullSpan = productDescriptionDisplay.querySelector('.description-full');
                    const seeMoreBtn = productDescriptionDisplay.querySelector('.see-more-btn');
                    
                    if (shortSpan && fullSpan) {
                        shortSpan.textContent = variantDescriptionShort || "No description available";
                        fullSpan.textContent = variantDescriptionFull || "No description available";
                        
                        // Show/hide see more button based on description length
                        if (seeMoreBtn && variantDescriptionFull && variantDescriptionFull.split(' ').length > 12) {
                            seeMoreBtn.style.display = 'inline';
                            seeMoreBtn.textContent = 'See more';
                        } else if (seeMoreBtn) {
                            seeMoreBtn.style.display = 'none';
                        }
                    }
                }
                
                // Update image
                const productImageDisplay = document.getElementById(`product-image-${productId}`);
                if (productImageDisplay && variantImage) {
                    productImageDisplay.src = variantImage;
                }
            });
        });

        // ---- Buy Now Button Click (FIXED LOGIC) ----
        buyNowButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
                if (!isAuthenticated) {
                    loginModal.show();
                    return;
                }
                const form = this.closest('form');
                const quantity = form.querySelector('input[name="quantity"]').value;
                const variantId = form.querySelector('select[name="variant_id"]').value;
                const productId = this.dataset.productId;
                
                // FIX 1: Set the hidden fields in the checkout form for POST submission
                // These values are read by the confirm_order view on form submit.
                if (checkoutVariantIdInput && checkoutQuantityInput) {
                    checkoutVariantIdInput.value = variantId;
                    checkoutQuantityInput.value = quantity;
                }
                
                // FIX 2: Set the action URL to the correct confirmation endpoint, 
                // removing the unnecessary query parameter.
                checkoutForm.action = `{% url 'order:confirm_order' %}`;

                // This AJAX call renders the summary HTML inside the modal
                fetch(`/buy-now/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ 
                        quantity: quantity,
                        variant_id: variantId
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        checkoutSummary.innerHTML = data.summary_html;
                        checkoutModal.show();
                        attachQuantityListeners();
                    } else {
                        Swal.fire('Error', data.message || 'Unable to start Buy Now.', 'error');
                    }
                })
                .catch(err => console.error('Buy Now error:', err));
            });
        });

        // ---- Add to Cart Button Click ----
        addToCartButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
                if (!isAuthenticated) {
                    loginModal.show();
                    return;
                }
                const form = this.closest('form');
                const quantity = form.querySelector('input[name="quantity"]').value;
                const variantId = form.querySelector('select[name="variant_id"]').value;
                const productId = this.dataset.productId;

                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ 
                        quantity: quantity,
                        variant_id: variantId
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Added to cart!',
                            text: 'Your product has been added successfully.',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            showCloseButton: true,
                            timer: 3000
                        });
                        refreshCart(data);
                    } else {
                        Swal.fire('Error', data.message || 'Unable to add to cart.', 'error');
                    }
                })
                .catch(err => console.error('Add to Cart error:', err));
            });
        });

        // ---- Cart Sidebar Listeners (all in one place) ----
        // This function attaches all event listeners related to the sidebar
        // so we can call it after updating the HTML content.
        function attachSidebarListeners() {
            // Remove previous listeners to prevent duplicates
            cartItemsWrap.removeEventListener("change", handleQuantityChange);
            cartItemsWrap.removeEventListener("click", handleRemoveItem);

            // ---- Quantity Change in sidebar ----
            cartItemsWrap.addEventListener("change", handleQuantityChange);

            // ---- Remove Item in sidebar ----
            cartItemsWrap.addEventListener("click", handleRemoveItem);

            function handleQuantityChange(e) {
                if (e.target.classList.contains("quantity-input")) {
                    const cartItemDiv = e.target.closest(".cart-item");
                    const itemId = cartItemDiv.dataset.itemId;
                    const newQuantity = e.target.value;

                    fetch(`/cart/update/${itemId}/`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken"),
                        },
                        body: JSON.stringify({ quantity: newQuantity }),
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            refreshCart(data);
                        } else {
                            alert(data.error || "Failed to update cart.");
                        }
                    })
                    .catch(err => console.error("Error updating cart:", err));
                }
            }

            function handleRemoveItem(e) {
                const removeBtn = e.target.closest(".remove-item");
                if (removeBtn) {
                    const itemId = removeBtn.closest(".cart-item").dataset.itemId;
                    fetch(`/cart/remove/${itemId}/`, {
                        method: "POST",
                        headers: { "X-CSRFToken": getCookie("csrftoken") },
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            refreshCart(data);
                        } else {
                            alert("Failed to remove item.");
                        }
                    })
                    .catch(err => console.error("Error removing item:", err));
                }
            }
        }
        
        // Initial call to attach listeners to the sidebar content
        attachSidebarListeners();

        // ---- See More/Show Less Functionality ----
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('see-more-btn')) {
                e.preventDefault();
                const productId = e.target.dataset.productId;
                const shortSpan = document.getElementById(`description-short-${productId}`);
                const fullSpan = document.getElementById(`description-full-${productId}`);
                const seeMoreBtn = e.target;
                
                if (shortSpan && fullSpan && seeMoreBtn) {
                    if (shortSpan.style.display !== 'none') {
                        // Currently showing short, so show full
                        shortSpan.style.display = 'none';
                        fullSpan.style.display = 'inline';
                        seeMoreBtn.textContent = 'Show less';
                    } else {
                        // Currently showing full, so show short
                        shortSpan.style.display = 'inline';
                        fullSpan.style.display = 'none';
                        seeMoreBtn.textContent = 'See more';
                    }
                }
            }
        });

        // ---- Sidebar Toggle Listeners ----
        cartIcons.forEach(icon => {
            icon.addEventListener("click", () => {
                cartSidebar.classList.add("open");
                cartBackdrop.style.display = "block";
            });
        });
        closeCartBtn.addEventListener("click", () => {
            cartSidebar.classList.remove("open");
            cartBackdrop.style.display = "none";
        });
        cartBackdrop.addEventListener("click", () => {
            cartSidebar.classList.remove("open");
            cartBackdrop.style.display = "none";
        });

        // ---- Checkout Button in Sidebar Click ----
        if (sidebarCheckoutBtn) {
            sidebarCheckoutBtn.addEventListener('click', function() {
                // Close the sidebar first
                cartSidebar.classList.remove("open");
                cartBackdrop.style.display = "none";

                // Ensure Buy Now fields are cleared for cart checkout
                if (checkoutVariantIdInput && checkoutQuantityInput) {
                    checkoutVariantIdInput.value = "";
                    checkoutQuantityInput.value = "";
                }
                
                checkoutForm.action = "{% url 'order:confirm_order' %}";
                fetch('/cart/summary/')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            checkoutSummary.innerHTML = data.summary_html;
                            checkoutModal.show();
                            attachQuantityListeners();
                        }
                    })
                    .catch(err => console.error('Error fetching cart summary:', err));
            });
        }
    });
</script>
{% endblock %}