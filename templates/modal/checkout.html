<div
  class="modal fade"
  id="checkoutModal"
  tabindex="-1"
  aria-labelledby="checkoutModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form
        id="checkoutForm"
        method="post"
        novalidate
      >
        {% csrf_token %}
        
        <input type="hidden" name="variant_id" id="checkout_variant_id" value=""> 
        <input type="hidden" name="quantity" id="checkout_quantity" value=""> 
        <div class="modal-header">
          <h5 class="modal-title" id="checkoutModalLabel">Order Summary</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body">
          <div id="checkoutSummary"></div>

          <h5 class="mt-4">Delivery Address</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="full_name" class="form-label">Full Name</label>
              <input
                type="text"
                class="form-control"
                name="full_name"
                id="full_name"
                value="{{ request.user.get_full_name }}"
                required
              />
              <div class="invalid-feedback">Full name is required.</div>
            </div>

            <div class="col-md-6">
              <label for="phone" class="form-label">Phone</label>
              <input
                type="tel"
                class="form-control"
                name="phone"
                id="phone"
                pattern="^[0-9]{10,15}$"
                required
              />
              <div class="invalid-feedback">
                Please enter a valid phone number (10–15 digits).
              </div>
            </div>

            <div class="col-md-6">
              <label for="street" class="form-label">House No / Street</label>
              <input
                type="text"
                class="form-control"
                name="street"
                id="street"
                required
              />
              <div class="invalid-feedback">Street address is required.</div>
            </div>

            <div class="col-md-6">
              <label for="city" class="form-label">City</label>
              <input
                type="text"
                class="form-control"
                name="city"
                id="city"
                required
              />
              <div class="invalid-feedback">City is required.</div>
            </div>

            <div class="col-md-6">
              <label for="state" class="form-label">State</label>
              <input type="text" class="form-control" name="state" id="state" />
              <div class="invalid-feedback">Please provide a state.</div>
            </div>

            <div class="col-md-3">
              <label for="postcode" class="form-label">Postcode</label>
              <input
                type="text"
                class="form-control"
                name="postcode"
                id="postcode"
                pattern="^[A-Za-z0-9\s\-]{4,10}$"
                required
              />
              <div class="invalid-feedback">
                Please enter a valid postcode (4–10 characters).
              </div>
            </div>

            <div class="col-md-3">
              <label for="country" class="form-label">Country</label>
              <input
                type="text"
                class="form-control"
                name="country"
                id="country"
                value="UK"
                required
              />
              <div class="invalid-feedback">Country is required.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Confirm Order</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const checkoutSummary = document.getElementById("checkoutSummary");
    const checkoutForm = document.getElementById("checkoutForm");
    
    // --- Access the new hidden fields ---
    const checkoutVariantIdInput = document.getElementById('checkout_variant_id');
    const checkoutQuantityInput = document.getElementById('checkout_quantity');

    // --- 1. Cart/Quantity Update Listener ---
    checkoutSummary.addEventListener("change", function (e) {
        const input = e.target;

        if (input.classList.contains("checkout-quantity-input")) {
            const newQuantity = parseInt(input.value);

            // Check if this is a Buy Now item
            if (input.classList.contains("buy-now-input")) {
                
                // Update the hidden quantity field for final submission
                checkoutQuantityInput.value = newQuantity;

                // Get the row elements
                const row = input.closest('tr');
                const unitPriceElement = row.querySelector('td:nth-child(3)');
                const lineTotalElement = row.querySelector('.item-line-total');
                const totalElement = document.getElementById('checkoutTotal');

                // Extract unit price (e.g., "£10.00")
                const unitPriceString = unitPriceElement.textContent.replace('£', '');
                const unitPrice = parseFloat(unitPriceString);

                // Calculate new line total
                const newLineTotal = newQuantity * unitPrice;
                
                // Update the visible total
                lineTotalElement.textContent = '£' + newLineTotal.toFixed(2);
                totalElement.textContent = '£' + newLineTotal.toFixed(2);
                
            } else {
                // Existing logic for regular cart items (requires server roundtrip)
                const itemId = input.dataset.itemId;
                
                fetch(`/cart/update/${itemId}/`, {
                    method: "POST",
                    headers: {
                      'X-CSRFToken': getCookie('csrftoken'),
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity: newQuantity })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // 1. Update checkout summary
                        fetch(`/cart/summary/`) 
                          .then(res => res.json())
                          .then(summary => {
                            if (summary.success) {
                              checkoutSummary.innerHTML = summary.summary_html;
                            }
                        });

                        // 2. Update cart sidebar
                        if (typeof refreshCart === "function") {
                            refreshCart(data);
                        }
                    }
                })
                .catch(err => console.error("Checkout update error:", err));
            }
        }
    });

  // ---- CSRF helper ----
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>